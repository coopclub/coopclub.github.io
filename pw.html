<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>陪玩信息展示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#F3F4F6',
                        neutral: '#6B7280',
                        danger: '#EF4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .list-item-hover {
                @apply hover:bg-primary/5 transition-colors duration-200;
            }
            .content-auto {
                content-visibility: auto;
            }
            .form-input {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-gray-200;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .tag-item {
                @apply inline-block px-2 py-1 rounded text-xs mr-2 mb-2 cursor-pointer transition-colors;
            }
            .modal-backdrop {
                @apply fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden;
            }
            .loading-state {
                @apply py-12 text-center text-neutral;
            }
        }
        html, body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1;
        }
        .logo-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
        }
        /* 优化大量数据的滚动体验 */
        .data-container {
            max-height: calc(100vh - 240px);
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold text-primary flex items-center">
                    <img src="dc8e19c02c5ea9a95711892e37523b9e.png" alt="logo" class="logo-img">陪玩信息列表
                </h1>
                <a href="index.html" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
                    <i class="fa fa-arrow-left mr-1"></i>返回列表
                </a>
                <a href="addCont.html" id="addPwBtn" class="text-sm bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors hidden">
                    <i class="fa fa-plus mr-1"></i>添加陪玩
                </a>
            </div>
            <div class="text-sm text-neutral">
                共 <span class="text-primary font-semibold" id="onlineCount">0</span> 位陪玩在线
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div style="text-align: center;margin-top: -20px; font-weight: 600;">QQ咨询群: 419972410，点单进群找值班接待!!!</div>
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-wrap gap-3 items-center">
                <div class="flex items-center">
                    <label class="text-sm text-neutral mr-2">接单类型：</label>
                    <select class="px-3 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary" id="serviceTypeFilter">
                        <option value="all">全部</option>
                        <option value="mobile">手游</option>
                        <option value="pc">端游</option>
                    </select>
                </div>
                <div class="flex-grow flex justify-end">
                    <input type="text" placeholder="搜索陪玩昵称/输入管理口令..." class="px-3 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary w-64" id="searchInput">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm overflow-hidden" id="pwListContainer">
            <div class="grid grid-cols-12 bg-secondary py-3 px-4 text-sm font-medium text-neutral">
                <div class="col-span-2">昵称/年龄</div>
                <div class="col-span-6">接单类型</div>
                <div class="col-span-2">主页链接</div>
                <div class="col-span-2">操作</div>
            </div>
            <!-- 添加滚动容器，优化大量数据显示 -->
            <div id="pwListContent" class="data-container"></div>
        </div>
    </main>

    <footer class="bg-white mt-0 py-6 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-sm text-neutral">
            <p>© 2026 笼club 陪玩信息展示平台 | 简洁列表版</p>
        </div>
    </footer>

    <script>
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12') {
                e.preventDefault();
            }
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
            }
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
            }
            if (e.shiftKey && e.button === 2) {
                e.preventDefault();
            }
        });

        function detectDevTools() {
            const devtools = /./;
            devtools.toString = function() {
                return '';
            };
        }
        setInterval(detectDevTools, 10000);

        const onlineCountElement = document.getElementById('onlineCount');
        const pwListContent = document.getElementById('pwListContent');
        const searchInput = document.getElementById('searchInput');
        const serviceTypeFilter = document.getElementById('serviceTypeFilter');
        const addPwBtn = document.getElementById('addPwBtn');
        const mm1 = 'ghp';
        const mm2 = '_qhEnzfDPTs1I6C90X';
        const mm3 = 'l9m8eF4GD3Jxz4S0QAp'
        
        const CONFIG = {
            github: {
                owner: 'coopclub', 
                repo: 'coopclub.github.io', 
                issueNumber: 1,
                token: mm1 + mm2 + mm3,
                perPage: 100 // 单次请求最大数量（GitHub API 最大支持100）
            },
            encryptedPassword: 'ZnJyczUzNTk0ODU0', 
            isAuth: false,
            commentIdMap: {},
            allData: [] // 存储所有数据，不再使用分页
        };

        function encrypt(str) {
            let offsetStr = '';
            for (let i = 0; i < str.length; i++) {
                offsetStr += String.fromCharCode(str.charCodeAt(i) + 3);
            }
            return btoa(unescape(encodeURIComponent(offsetStr)));
        }

        function decrypt(str) {
            try {
                const decoded = decodeURIComponent(escape(atob(str)));
                let originalStr = '';
                for (let i = 0; i < decoded.length; i++) {
                    originalStr += String.fromCharCode(decoded.charCodeAt(i) - 3);
                }
                return originalStr;
            } catch (e) {
                return '';
            }
        }
        
        function checkAuth(inputVal) {
            if (!inputVal) {
                CONFIG.isAuth = false;
                addPwBtn.classList.add('hidden');
                document.querySelectorAll('.delete-pw-btn').forEach(btn => {
                    btn.classList.add('hidden');
                });
                return;
            }
            const encryptedInput = encrypt(inputVal);
            const isMatch = encryptedInput === CONFIG.encryptedPassword || inputVal === CONFIG.encryptedPassword;
            CONFIG.isAuth = isMatch;
            addPwBtn.classList.toggle('hidden', !isMatch);
            document.querySelectorAll('.delete-pw-btn').forEach(btn => {
                btn.classList.toggle('hidden', !isMatch);
            });
        }

        // 循环获取所有分页的GitHub评论数据
        async function getAllPwDataFromGitHub() {
            pwListContent.innerHTML = `<div class="loading-state"><i class="fa fa-spinner fa-spin mb-2 text-2xl"></i><p>正在加载陪玩数据...</p></div>`;
            
            let allComments = [];
            let page = 1;
            const perPage = CONFIG.github.perPage;
            
            try {
                while (true) {
                    // 每次请求添加page和per_page参数，获取分页数据
                    const response = await fetch(
                        `https://api.github.com/repos/${CONFIG.github.owner}/${CONFIG.github.repo}/issues/${CONFIG.github.issueNumber}/comments?page=${page}&per_page=${perPage}`,
                        {
                            headers: {
                                'Authorization': `token ${CONFIG.github.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (!response.ok) {
                        if (response.status === 404 || response.status === 403) {
                            break;
                        }
                        throw new Error(`请求失败：${response.status}`);
                    }

                    const comments = await response.json();
                    
                    // 如果当前页没有数据，说明已经获取完所有数据
                    if (comments.length === 0) {
                        break;
                    }
                    
                    allComments = allComments.concat(comments);
                    page++;
                    
                    // 防止请求过快触发GitHub限流
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // 解析所有评论数据
                CONFIG.commentIdMap = {};
                const pwData = allComments.map(comment => {
                    try {
                        const data = JSON.parse(comment.body);
                        CONFIG.commentIdMap[data.id] = comment.id;
                        return data;
                    } catch (e) {
                        console.error('解析评论数据失败', e);
                        return null;
                    }
                }).filter(item => item !== null);

                CONFIG.allData = pwData;
                return pwData;
            } catch (error) {
                console.error('获取GitHub Issues数据失败：', error);
                pwListContent.innerHTML = `<div class="loading-state"><i class="fa fa-exclamation-circle mb-2 text-2xl text-red-500"></i><p>数据加载失败，请刷新页面重试</p></div>`;
                return [];
            }
        }

        async function deletePwData(pwId) {
            if (!confirm('确定要删除这条陪玩信息吗？删除后无法恢复！')) {
                return;
            }

            const commentId = CONFIG.commentIdMap[pwId];
            if (!commentId) {
                alert('未找到对应的评论ID，删除失败！');
                return;
            }

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${CONFIG.github.owner}/${CONFIG.github.repo}/issues/comments/${commentId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${CONFIG.github.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`删除失败：${response.status}`);
                }

                alert('删除成功！');
                // 删除后重新加载所有数据
                await initData();
                filterData();
            } catch (error) {
                console.error('删除陪玩数据失败：', error);
                alert('删除失败，请重试！');
            }
        }

        // 初始化数据
        async function initData() {
            const githubData = await getAllPwDataFromGitHub();
            CONFIG.allData = githubData;
            onlineCountElement.textContent = githubData.length;
        }

        // 渲染所有数据（不分页）
        function renderAllData(data) {
            if (data.length === 0) {
                pwListContent.innerHTML = `<div class="loading-state"><i class="fa fa-search mb-2 text-2xl"></i><p>暂无匹配的陪玩信息</p></div>`;
                return;
            }
            
            // 生成所有数据的HTML
            const html = data.map(item => {
                const services = Array.isArray(item.services) ? item.services : item.services.split(',').filter(Boolean);
                const games = Array.isArray(item.games) ? item.games : item.games.split(',').filter(Boolean);
                
                const serviceTags = services.map(s => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded mr-1 mb-1">${s}</span>`).join('');
                const gameTags = games.map(g => `<span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded mr-1 mb-1">${g}</span>`).join('');
                
                const linkHtml = item.homepageUrl ? `<a href="${item.homepageUrl}" target="_blank" class="text-primary text-sm flex items-center hover:text-primary/80"><i class="fa fa-link mr-1"></i> 查看</a>` : '<span class="text-neutral text-sm">暂无链接</span>';
                
                const deleteBtnHtml = `
                    <button class="delete-pw-btn text-sm bg-danger text-white px-3 py-1 rounded hover:bg-danger/90 transition-colors hidden" onclick="deletePwData('${item.id}')">
                        <i class="fa fa-trash mr-1"></i>删除
                    </button>
                `;
                
                return `
                <div class="grid grid-cols-12 py-4 px-4 border-b border-gray-100 list-item-hover items-center">
                    <div class="col-span-2">
                        <div class="font-medium">${item.nickname || '未填写'}</div>
                        <div class="text-xs text-neutral">${item.age || '未知'}岁</div>
                    </div>
                    <div class="col-span-6">${serviceTags}${gameTags}</div>
                    <div class="col-span-2">${linkHtml}</div>
                    <div class="col-span-2">${deleteBtnHtml}</div>
                </div>`;
            }).join('');
            
            pwListContent.innerHTML = html;

            // 如果有权限，显示删除按钮
            if (CONFIG.isAuth) {
                document.querySelectorAll('.delete-pw-btn').forEach(btn => {
                    btn.classList.remove('hidden');
                });
            }
        }
        
        // 筛选数据（不再分页）
        function filterData() {
            const keyword = searchInput.value.toLowerCase().trim();
            const serviceType = serviceTypeFilter.value;
            
            // 先验证权限
            checkAuth(keyword);
            
            // 复制原始数据进行筛选
            let filteredData = [...CONFIG.allData];
            
            // 昵称搜索筛选（非管理员状态下）
            if (keyword && !CONFIG.isAuth) {
                filteredData = filteredData.filter(item => {
                    return item.nickname && item.nickname.toLowerCase().includes(keyword);
                });
            }
            
            // 接单类型筛选
            if (serviceType !== 'all') {
                filteredData = filteredData.filter(item => {
                    const servicesStr = (Array.isArray(item.services) ? item.services.join(',') : item.services || '').toLowerCase();
                    return serviceType === 'mobile' ? servicesStr.includes('手游') : servicesStr.includes('端游');
                });
            }

            // 渲染所有筛选后的数据
            renderAllData(filteredData);
            // 更新计数显示
            onlineCountElement.textContent = filteredData.length;
        }
        
        // 页面加载完成初始化
        document.addEventListener('DOMContentLoaded', async () => {
            await initData(); 
            filterData(); 
            // 绑定筛选事件
            searchInput.addEventListener('input', filterData);
            serviceTypeFilter.addEventListener('change', filterData);
        });
    </script>
</body>
</html>
