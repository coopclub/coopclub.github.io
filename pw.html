<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>陪玩信息展示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#F3F4F6',
                        neutral: '#6B7280',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .list-item-hover {
                @apply hover:bg-primary/5 transition-colors duration-200;
            }
            .content-auto {
                content-visibility: auto;
            }
            .form-input {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-gray-200;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .tag-item {
                @apply inline-block px-2 py-1 rounded text-xs mr-2 mb-2 cursor-pointer transition-colors;
            }
            .modal-backdrop {
                @apply fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden;
            }
            .loading-state {
                @apply py-12 text-center text-neutral;
            }
        }
        /* 新增：粘性底部核心样式 */
        html, body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        main {
            flex: 1; /* 让main占满剩余空间，把footer推到底部 */
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <!-- 页面头部 -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold text-primary">
                    <i class="fa fa-gamepad mr-2"></i>陪玩信息列表
                </h1>
                <a href="index.html" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
                    <i class="fa fa-arrow-left mr-1"></i>返回列表
                </a>
                <a href="addCont.html" id="addPwBtn" class="text-sm bg-primary text-white px-3 py-1 rounded hover:bg-primary/90 transition-colors hidden">
                    <i class="fa fa-plus mr-1"></i>添加陪玩
                </a>
            </div>
            <div class="text-sm text-neutral">
                共 <span class="text-primary font-semibold" id="onlineCount">0</span> 位陪玩在线
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <!-- 筛选栏 -->
        <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-wrap gap-3 items-center">
                <div class="flex items-center">
                    <label class="text-sm text-neutral mr-2">接单类型：</label>
                    <select class="px-3 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary" id="serviceTypeFilter">
                        <option value="all">全部</option>
                        <option value="mobile">手游</option>
                        <option value="pc">端游</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <label class="text-sm text-neutral mr-2">接单时间：</label>
                    <select class="px-3 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary" id="timeFilter">
                        <option value="all">全部</option>
                        <option value="day">白天</option>
                        <option value="night">夜间</option>
                        <option value="24h">24小时</option>
                    </select>
                </div>
                <div class="flex-grow flex justify-end">
                    <input type="text" placeholder="搜索陪玩昵称/输入管理口令..." class="px-3 py-1 border border-gray-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-primary w-64" id="searchInput">
                </div>
            </div>
        </div>

        <!-- 陪玩列表 -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden" id="pwListContainer">
            <div class="grid grid-cols-12 bg-secondary py-3 px-4 text-sm font-medium text-neutral">
                <div class="col-span-2">昵称/年龄</div>
                <div class="col-span-2">接单类型</div>
                <div class="col-span-2">接单时间</div>
                <div class="col-span-3">试音视频</div>
                <div class="col-span-1">主页链接</div>
            </div>
            <div id="pwListContent"></div>
            <div class="flex justify-center mt-8 pb-4" id="paginationContainer"></div>
        </div>
    </main>

    <!-- 页面底部（固定在最底部） -->
    <footer class="bg-white mt-0 py-6 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-sm text-neutral">
            <p>© 2026 笼club 陪玩信息展示平台 | 简洁列表版</p>
        </div>
    </footer>

    <script>
        // ========== 新增：防调试/防右键核心代码 ==========
        // 1. 禁用鼠标右键菜单
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault(); // 阻止右键菜单弹出
        });

        // 2. 禁用F12、Ctrl+Shift+I、Ctrl+U、Ctrl+S等调试/查看源码快捷键
        document.addEventListener('keydown', function(e) {
            // 禁用F12
            if (e.key === 'F12') {
                e.preventDefault();
            }
            // 禁用Ctrl+Shift+I（开发者工具）
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
            }
            // 禁用Ctrl+U（查看页面源代码）
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
            }
            // 禁用Ctrl+S（保存页面）
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
            }
            // 禁用Shift+右键（菜单）
            if (e.shiftKey && e.button === 2) {
                e.preventDefault();
            }
        });

        // 3. 检测开发者工具打开并屏蔽（增强防护）
        function detectDevTools() {
            const devtools = /./;
            devtools.toString = function() {
                // 检测到开发者工具打开时，清空页面内容（可选）
                // document.body.innerHTML = '<h1 class="text-center text-red-500 mt-10">禁止调试！</h1>';
                return '';
            };
            // console.log('%c', devtools); // 触发检测
        }
        // 定时检测
        setInterval(detectDevTools, 10000);

        // ========== 核心修改：改用 GitHub Issues 读取数据 ==========
        const onlineCountElement = document.getElementById('onlineCount');
        const pwListContent = document.getElementById('pwListContent');
        const paginationContainer = document.getElementById('paginationContainer');
        const searchInput = document.getElementById('searchInput');
        const serviceTypeFilter = document.getElementById('serviceTypeFilter');
        const timeFilter = document.getElementById('timeFilter');
        const addPwBtn = document.getElementById('addPwBtn');
        const mm1 = 'ghp';
        const mm2 = '_qhEnzfDPTs1I6C90X';
        const mm3 = 'l9m8eF4GD3Jxz4S0QAp'
        // 配置修改：改用 Issues 相关配置
        const CONFIG = {
            // GitHub Issues 配置（和添加页面保持一致）
            github: {
                owner: 'coopclub', 
                repo: 'coopclub.github.io', 
                issueNumber: 1, // 替换为你新建的Issue编号
                token: mm1 + mm2 + mm3
            },
            encryptedPassword: 'ZnJyczUzNTk0ODU0', 
            isAuth: false,
            pagination: {
                currentPage: 1,
                pageSize: 3,
                totalItems: 0,
                totalPages: 0,
                data: []
            }
        };

        // 加密/解密算法（保持不变）
        function encrypt(str) {
            let offsetStr = '';
            for (let i = 0; i < str.length; i++) {
                offsetStr += String.fromCharCode(str.charCodeAt(i) + 3);
            }
            return btoa(unescape(encodeURIComponent(offsetStr)));
        }

        function decrypt(str) {
            try {
                const decoded = decodeURIComponent(escape(atob(str)));
                let originalStr = '';
                for (let i = 0; i < decoded.length; i++) {
                    originalStr += String.fromCharCode(decoded.charCodeAt(i) - 3);
                }
                return originalStr;
            } catch (e) {
                return '';
            }
        }
        
        // 权限验证（保持不变）
        function checkAuth(inputVal) {
            if (!inputVal) {
                CONFIG.isAuth = false;
                addPwBtn.classList.add('hidden');
                return;
            }
            const encryptedInput = encrypt(inputVal);
            const isMatch = encryptedInput === CONFIG.encryptedPassword || inputVal === CONFIG.encryptedPassword;
            CONFIG.isAuth = isMatch;
            addPwBtn.classList.toggle('hidden', !isMatch);
        }
        
        // 视频播放/关闭（保持不变）
        function playVideo(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeVideo(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                const video = modal.querySelector('video');
                video && video.pause();
            }
        }

        // 点击弹窗外部关闭（保持不变）
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-backdrop')) {
                closeVideo(e.target.id);
            }
        });

        // 核心修改：从 GitHub Issues 读取数据（替代原来的读取文件）
        async function getPwDataFromGitHub() {
            // 显示加载状态
            pwListContent.innerHTML = `<div class="loading-state"><i class="fa fa-spinner fa-spin mb-2 text-2xl"></i><p>正在加载陪玩数据...</p></div>`;
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${CONFIG.github.owner}/${CONFIG.github.repo}/issues/${CONFIG.github.issueNumber}/comments`,
                    {
                        headers: {
                            'Authorization': `token ${CONFIG.github.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (!response.ok) {
                    // 如果Issue不存在或无权限，返回空数组
                    if (response.status === 404 || response.status === 403) {
                        return [];
                    }
                    throw new Error(`请求失败：${response.status}`);
                }

                // 读取所有评论，每个评论是一条陪玩数据
                const comments = await response.json();
                // 解析评论内容为JSON数据
                const pwData = comments.map(comment => {
                    try {
                        return JSON.parse(comment.body);
                    } catch (e) {
                        console.error('解析评论数据失败', e);
                        return null;
                    }
                }).filter(item => item !== null); // 过滤解析失败的数据

                return pwData;
            } catch (error) {
                console.error('获取GitHub Issues数据失败：', error);
                pwListContent.innerHTML = `<div class="loading-state"><i class="fa fa-exclamation-circle mb-2 text-2xl text-red-500"></i><p>数据加载失败，请刷新页面重试</p></div>`;
                return [];
            }
        }

        // 初始化数据（逻辑不变，数据源已替换）
        async function initData() {
            // 从GitHub Issues获取数据
            const githubData = await getPwDataFromGitHub();
            // 赋值给分页数据
            CONFIG.pagination.data = githubData;
            CONFIG.pagination.totalItems = githubData.length;
            CONFIG.pagination.totalPages = Math.ceil(CONFIG.pagination.totalItems / CONFIG.pagination.pageSize);
            // 更新在线数量
            onlineCountElement.textContent = CONFIG.pagination.totalItems;
        }

        // 渲染列表（保持不变）
        function renderList(data) {
            if (data.length === 0) {
                pwListContent.innerHTML = `<div class="loading-state"><i class="fa fa-search mb-2 text-2xl"></i><p>暂无匹配的陪玩信息</p></div>`;
                return;
            }
            pwListContent.innerHTML = data.map(item => {
                // 处理标签数据
                const services = Array.isArray(item.services) ? item.services : item.services.split(',').filter(Boolean);
                const games = Array.isArray(item.games) ? item.games : item.games.split(',').filter(Boolean);
                
                const serviceTags = services.map(s => `<span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${s}</span>`).join('');
                const gameTags = games.map(g => `<span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded mt-1">${g}</span>`).join('');
                
                const videoHtml = item.videoUrl ? `
                    <button class="text-primary text-sm flex items-center hover:text-primary/80" onclick="playVideo('${item.id}')">
                        <i class="fa fa-play-circle mr-1"></i> 播放试音
                    </button>
                    <div id="${item.id}" class="modal-backdrop">
                        <div class="bg-white rounded-lg w-full max-w-lg p-4 relative">
                            <button onclick="closeVideo('${item.id}')" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">
                                <i class="fa fa-times text-xl"></i>
                            </button>
                            <video controls class="w-full h-auto">
                                <source src="${item.videoUrl}" type="video/mp4">浏览器不支持播放
                            </video>
                        </div>
                    </div>
                ` : '<span class="text-neutral text-sm">暂无试音</span>';
                
                const linkHtml = item.homepageUrl ? `<a href="${item.homepageUrl}" target="_blank" class="text-primary text-sm flex items-center hover:text-primary/80"><i class="fa fa-link mr-1"></i> 查看</a>` : '<span class="text-neutral text-sm">暂无链接</span>';
                
                return `
                <div class="grid grid-cols-12 py-4 px-4 border-b border-gray-100 list-item-hover items-center">
                    <div class="col-span-2">
                        <div class="font-medium">${item.nickname || '未填写'}</div>
                        <div class="text-xs text-neutral">${item.age || '未知'}岁</div>
                    </div>
                    <div class="col-span-2">${serviceTags}${gameTags}</div>
                    <div class="col-span-2 text-sm">${item.availableTime || '未填写'}</div>
                    <div class="col-span-3">${videoHtml}</div>
                    <div class="col-span-1">${linkHtml}</div>
                </div>`;
            }).join('');
        }

        // 渲染分页（保持不变）
        function renderPagination() {
            const { totalPages, currentPage } = CONFIG.pagination;
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            let pageHtml = `
                <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
                    <a href="#" class="relative inline-flex items-center px-3 py-2 text-sm font-medium ${currentPage === 1 ? 'text-gray-400 bg-gray-100 cursor-not-allowed' : 'text-gray-500 bg-white hover:bg-gray-50'}" onclick="changePage(${currentPage - 1})"><i class="fa fa-chevron-left text-xs"></i></a>
            `;
            for (let i = 1; i <= totalPages; i++) {
                pageHtml += `<a href="#" class="relative inline-flex items-center px-4 py-2 text-sm font-medium ${i === currentPage ? 'text-primary bg-primary/5' : 'text-gray-700 bg-white hover:bg-gray-50'}" onclick="changePage(${i})">${i}</a>`;
            }
            pageHtml += `
                    <a href="#" class="relative inline-flex items-center px-3 py-2 text-sm font-medium ${currentPage === totalPages ? 'text-gray-400 bg-gray-100 cursor-not-allowed' : 'text-gray-500 bg-white hover:bg-gray-50'}" onclick="changePage(${currentPage + 1})"><i class="fa fa-chevron-right text-xs"></i></a>
                </nav>
            `;
            paginationContainer.innerHTML = pageHtml;
        }

        // 切换页码（保持不变）
        function changePage(pageNum) {
            const { totalPages } = CONFIG.pagination;
            if (pageNum < 1 || pageNum > totalPages) return;
            CONFIG.pagination.currentPage = pageNum;
            filterData();
        }
        
        // 筛选数据（保持不变）
        function filterData() {
            const keyword = searchInput.value.toLowerCase().trim();
            const serviceType = serviceTypeFilter.value;
            const timeType = timeFilter.value;
            // 1. 先执行口令验证
            checkAuth(keyword);
            // 2. 再执行昵称搜索筛选
            let filteredData = [...CONFIG.pagination.data];
            if (keyword && !CONFIG.isAuth) {
                filteredData = filteredData.filter(item => {
                    return item.nickname && item.nickname.toLowerCase().includes(keyword);
                });
            }
            // 3. 接单类型筛选
            if (serviceType !== 'all') {
                filteredData = filteredData.filter(item => {
                    const servicesStr = (Array.isArray(item.services) ? item.services.join(',') : item.services || '').toLowerCase();
                    return serviceType === 'mobile' ? servicesStr.includes('手游') : servicesStr.includes('端游');
                });
            }
            // 4. 接单时间筛选
            if (timeType !== 'all') {
                filteredData = filteredData.filter(item => {
                    const timeStr = (item.availableTime || '').toLowerCase();
                    if (timeType === 'day') return timeStr.includes('白天') || (timeStr.includes('12') && !timeStr.includes('00:00'));
                    if (timeType === 'night') return timeStr.includes('夜间') || timeStr.includes('00:00');
                    if (timeType === '24h') return timeStr.includes('全天') || timeStr.includes('24小时');
                    return true;
                });
            }

            // 5. 分页处理
            const { currentPage, pageSize } = CONFIG.pagination;
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredData.slice(start, end);
            CONFIG.pagination.totalItems = filteredData.length;
            CONFIG.pagination.totalPages = Math.ceil(filteredData.length / pageSize);
            renderList(pageData);
            renderPagination();
        }
        
        // 页面加载初始化（保持不变）
        document.addEventListener('DOMContentLoaded', async () => {
            await initData(); 
            filterData(); 
            searchInput.addEventListener('input', filterData);
            serviceTypeFilter.addEventListener('change', filterData);
            timeFilter.addEventListener('change', filterData);
        });
    </script>
</body>
</html>

