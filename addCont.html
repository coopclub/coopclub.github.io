<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加陪玩信息 | 简洁列表版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#F3F4F6',
                        neutral: '#6B7280',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .form-input {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-gray-200;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
            .tag-item {
                @apply inline-flex items-center px-2 py-1 rounded text-xs mr-2 mb-2 cursor-pointer transition-colors;
            }
            .tag-delete {
                @apply ml-1 text-xs opacity-70 hover:opacity-100;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
    <!-- 页面头部 -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold text-primary">
                    <i class="fa fa-gamepad mr-2"></i>添加陪玩信息
                </h1>
                <a href="pw.html" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 transition-colors">
                    <i class="fa fa-arrow-left mr-1"></i>返回上一页
                </a>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-sm p-6 max-w-3xl mx-auto">
            <form id="addPwForm" class="space-y-6">
                <!-- 基本信息 -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-2">基本信息</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nickname" class="form-label">昵称/类型 <span class="text-red-500">*</span></label>
                            <input type="text" id="nickname" name="nickname" required
                                class="form-input" placeholder="例如：困宝（少萝/少女偏萝）">
                        </div>
                        <div>
                            <label for="age" class="form-label">年龄 <span class="text-red-500">*</span></label>
                            <input type="number" id="age" name="age" required
                                class="form-input" min="18" max="60" placeholder="请输入年龄">
                        </div>
                    </div>
                </div>

                <!-- 接单信息 -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-2">接单信息</h3>
                    <div>
                        <label class="form-label">接单类型（可多选，最多10个） <span class="text-red-500">*</span></label>
                        <div class="flex items-center mt-2 mb-2">
                            <input type="text" id="newServiceTag" class="form-input mr-2 w-auto flex-1" placeholder="输入自定义接单类型">
                            <button type="button" id="addServiceTagBtn" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors text-sm">
                                <i class="fa fa-plus mr-1"></i>添加
                            </button>
                        </div>
                        <div class="flex flex-wrap mt-2" id="serviceTags">
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="语聊">
                                语聊 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="哄睡">
                                哄睡 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="asmr">
                                asmr <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="手游">
                                手游 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="端游">
                                端游 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="ts语音">
                                ts语音 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="定制录音">
                                定制录音 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <input type="hidden" id="services" name="services" required>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">擅长游戏（可多选，最多10个） <span class="text-red-500">*</span></label>
                        <div class="flex items-center mt-2 mb-2">
                            <input type="text" id="newGameTag" class="form-input mr-2 w-auto flex-1" placeholder="输入自定义游戏名称">
                            <button type="button" id="addGameTagBtn" class="px-3 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors text-sm">
                                <i class="fa fa-plus mr-1"></i>添加
                            </button>
                        </div>
                        <div class="flex flex-wrap mt-2" id="gameTags">
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="王者">
                                王者 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="瓦罗兰特">
                                瓦罗兰特 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="steam游戏">
                                steam游戏 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="单机游戏">
                                单机游戏 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <span class="tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary" data-value="英雄联盟">
                                英雄联盟 <i class="fa fa-times tag-delete"></i>
                            </span>
                            <input type="hidden" id="games" name="games" required>
                        </div>
                    </div>
                    <div>
                        <label for="availableTime" class="form-label">接单时间 <span class="text-red-500">*</span></label>
                        <input type="text" id="availableTime" name="availableTime" required
                            class="form-input" placeholder="例如：12:00-03:00 或 全天在线">
                    </div>
                </div>

                <!-- 媒体信息（非必填） -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold border-b pb-2">媒体信息（选填）</h3>
                    <div>
                        <label for="videoUrl" class="form-label">试音视频URL</label>
                        <input type="url" id="videoUrl" name="videoUrl"
                            class="form-input" placeholder="https://example.com/video.mp4">
                    </div>
                    <div>
                        <label for="homepageUrl" class="form-label">主页链接</label>
                        <input type="url" id="homepageUrl" name="homepageUrl"
                            class="form-input" placeholder="https://example.com/home">
                    </div>
                </div>

                <!-- 提交按钮 -->
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="reset" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                        <i class="fa fa-refresh mr-1"></i>重置表单
                    </button>
                    <button type="submit" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">
                        <i class="fa fa-save mr-1"></i>保存信息
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- 页面底部 -->
    <footer class="bg-white mt-12 py-6 border-t border-gray-200">
        <div class="container mx-auto px-4 text-center text-sm text-neutral">
            <p>© 2026 笼club 陪玩信息展示平台 | 简洁列表版</p>
        </div>
    </footer>

    <script>
        const addPwForm = document.getElementById('addPwForm');
        const MAX_TAGS = 10;
        const mm1 = 'ghp';
        const mm2 = '_qhEnzfDPTs1I6C90X';
        const mm3 = 'l9m8eF4GD3Jxz4S0QAp'
        // GitHub 配置（替换成你的新Token）
        const GITHUB_CONFIG = {
            owner: 'coopclub',
            repo: 'coopclub.github.io', 
            path: 'data.json', 
            token: mm1 + mm2 + mm3
        };

        // 修复核心：重构Base64解码逻辑，完全容错
        function safeBase64Decode(base64Str) {
            try {
                // 步骤1：补全Base64缺失的等号（确保长度是4的倍数）
                const padded = base64Str.padEnd(base64Str.length + (4 - base64Str.length % 4) % 4, '=');
                // 步骤2：替换非法字符（部分场景会出现-/_代替+/)
                const normalized = padded.replace(/-/g, '+').replace(/_/g, '/');
                // 步骤3：安全解码
                return decodeURIComponent(escape(atob(normalized)));
            } catch (e) {
                console.warn('Base64解码失败，返回空字符串：', e);
                return '';
            }
        }

        // 获取GitHub数据（完全容错）
        async function getPwDataFromGitHub() {
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                // 场景1：文件不存在（404），返回空数组和空SHA
                if (response.status === 404) {
                    console.log('data.json不存在，将创建新文件');
                    return { data: [], sha: '' };
                }

                // 场景2：请求失败（非200/404）
                if (!response.ok) {
                    throw new Error(`请求失败：${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                // 场景3：文件存在，安全解码内容
                const content = safeBase64Decode(result.content || '');
                
                // 场景4：解析JSON，容错
                let pwData = [];
                try {
                    pwData = content ? JSON.parse(content) : [];
                } catch (parseError) {
                    console.warn('JSON解析失败，使用空数组：', parseError);
                    pwData = [];
                }

                return {
                    data: Array.isArray(pwData) ? pwData : [], // 确保是数组
                    sha: result.sha || ''
                };
            } catch (error) {
                console.error('获取GitHub数据失败：', error);
                alert('获取数据失败：' + error.message);
                throw error;
            }
        }

        // 【核心修复】保存数据到GitHub（确保追加而非覆盖）
        async function savePwDataToGitHub(newData) {
            try {
                // 1. 先获取旧数据和文件SHA（关键步骤）
                const { data: oldPwList, sha } = await getPwDataFromGitHub();
                
                // 2. 生成唯一ID（保留原有逻辑）
                const maxIdNum = oldPwList.reduce((max, item) => {
                    const num = parseInt(item.id?.replace('video', '')) || 0;
                    return num > max ? num : max;
                }, 4);
                const newId = `video${maxIdNum + 1}`;

                // 3. 组装新数据项
                const formattedData = {
                    id: newId,
                    nickname: newData.nickname,
                    age: newData.age, 
                    services: newData.services,
                    games: newData.games,
                    availableTime: newData.availableTime,
                    videoUrl: newData.videoUrl || '', 
                    homepageUrl: newData.homepageUrl || '' 
                };

                // 4. 核心修复：将新数据追加到旧数据末尾（而非覆盖）
                const newPwList = [...oldPwList, formattedData]; // 关键：展开旧数组 + 追加新项
                const newContent = JSON.stringify(newPwList, null, 2); // 序列化完整数组

                // 5. 提交到GitHub（必须传SHA，防止覆盖冲突）
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Add new pw info: ${formattedData.nickname} (${formattedData.id})`,
                            content: btoa(unescape(encodeURIComponent(newContent))),
                            sha: sha // 必须传文件SHA，GitHub用于校验版本
                        })
                    }
                );

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`GitHub API 错误：${error.message}（状态码：${response.status}）`);
                }

                return newId;
            } catch (error) {
                console.error('保存到GitHub失败：', error);
                alert('保存失败：' + error.message);
                throw error;
            }
        }

        // 工具函数（不变）
        function resetTagSelection() {
            const serviceTags = document.querySelectorAll('#serviceTags .tag-item');
            serviceTags.forEach(tag => {
                tag.classList.remove('bg-primary/10', 'text-primary');
                tag.classList.add('bg-gray-100', 'text-gray-800');
            });
            document.getElementById('services').value = '';
            
            const gameTags = document.querySelectorAll('#gameTags .tag-item');
            gameTags.forEach(tag => {
                tag.classList.remove('bg-primary/10', 'text-primary');
                tag.classList.add('bg-gray-100', 'text-gray-800');
            });
            document.getElementById('games').value = '';
        }

        function createTagElement(value) {
            const tag = document.createElement('span');
            tag.className = 'tag-item bg-gray-100 text-gray-800 hover:bg-primary/10 hover:text-primary';
            tag.setAttribute('data-value', value);
            tag.innerHTML = `${value} <i class="fa fa-times tag-delete"></i>`;
            return tag;
        }

        function addCustomTag(inputId, containerId) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);
            const tagValue = input.value.trim();
            
            if (!tagValue) {
                alert('请输入标签内容');
                return;
            }
            
            const tagCount = container.querySelectorAll('.tag-item').length;
            if (tagCount >= MAX_TAGS) {
                alert(`最多只能添加${MAX_TAGS}个标签`);
                return;
            }
            
            const existingTags = container.querySelectorAll(`.tag-item[data-value="${tagValue}"]`);
            if (existingTags.length > 0) {
                alert('该标签已存在');
                return;
            }
            
            const newTag = createTagElement(tagValue);
            container.insertBefore(newTag, container.lastElementChild);
            bindTagEvents(newTag);
            input.value = '';
        }

        function bindTagEvents(tagElement) {
            tagElement.addEventListener('click', function(e) {
                if (e.target.classList.contains('tag-delete')) return;
                
                const value = this.getAttribute('data-value');
                const container = this.parentElement;
                const hiddenInputId = container.id === 'serviceTags' ? 'services' : 'games';
                const hiddenInput = document.getElementById(hiddenInputId);
                
                let selectedTags = new Set(hiddenInput.value ? hiddenInput.value.split(',') : []);
                
                if (selectedTags.has(value)) {
                    selectedTags.delete(value);
                    this.classList.remove('bg-primary/10', 'text-primary');
                    this.classList.add('bg-gray-100', 'text-gray-800');
                } else {
                    selectedTags.add(value);
                    this.classList.remove('bg-gray-100', 'text-gray-800');
                    this.classList.add('bg-primary/10', 'text-primary');
                }
                
                hiddenInput.value = Array.from(selectedTags).join(',');
            });
            
            const deleteBtn = tagElement.querySelector('.tag-delete');
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const tag = this.parentElement;
                const value = tag.getAttribute('data-value');
                const container = tag.parentElement;
                const hiddenInputId = container.id === 'serviceTags' ? 'services' : 'games';
                const hiddenInput = document.getElementById(hiddenInputId);
                
                let selectedTags = new Set(hiddenInput.value ? hiddenInput.value.split(',') : []);
                selectedTags.delete(value);
                hiddenInput.value = Array.from(selectedTags).join(',');
                tag.remove();
            });
        }

        function setupTagSelection(tagContainerId) {
            const container = document.getElementById(tagContainerId);
            const tags = container.querySelectorAll('.tag-item');
            tags.forEach(tag => {
                bindTagEvents(tag);
            });
        }

        // 表单提交
        addPwForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                nickname: document.getElementById('nickname').value.trim(),
                age: document.getElementById('age').value.trim(),
                services: document.getElementById('services').value.split(',').filter(Boolean),
                games: document.getElementById('games').value.split(',').filter(Boolean),
                availableTime: document.getElementById('availableTime').value.trim(),
                videoUrl: document.getElementById('videoUrl').value.trim(),
                homepageUrl: document.getElementById('homepageUrl').value.trim()
            };

            // 验证
            if (!formData.nickname) {
                alert('请输入昵称/类型！');
                return;
            }
            if (!formData.age || isNaN(formData.age) || formData.age < 18 || formData.age > 60) {
                alert('请输入18-60之间的有效年龄！');
                return;
            }
            if (!formData.availableTime) {
                alert('请输入接单时间！');
                return;
            }
            if (!formData.services.length) {
                alert('请至少选择一项接单类型！');
                return;
            }
            if (!formData.games.length) {
                alert('请至少选择一项擅长游戏！');
                return;
            }

            try {
                await savePwDataToGitHub(formData);
                alert('陪玩信息添加成功！即将返回列表页');
                window.location.href = 'pw.html';
            } catch (error) {
                console.error('提交失败：', error);
                alert('添加失败，请检查GitHub配置或重试！');
            }
        });

        // 初始化
        setupTagSelection('serviceTags');
        setupTagSelection('gameTags');

        document.getElementById('addServiceTagBtn').addEventListener('click', () => {
            addCustomTag('newServiceTag', 'serviceTags');
        });
        document.getElementById('addGameTagBtn').addEventListener('click', () => {
            addCustomTag('newGameTag', 'gameTags');
        });
        
        document.getElementById('newServiceTag').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addCustomTag('newServiceTag', 'serviceTags');
        });
        document.getElementById('newGameTag').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addCustomTag('newGameTag', 'gameTags');
        });

        addPwForm.addEventListener('reset', function() {
            setTimeout(resetTagSelection, 0);
        });

        document.addEventListener('DOMContentLoaded', resetTagSelection);
    </script>
</body>
</html>
